name: Locust Load Test (Run by Endpoints)

on:
  workflow_dispatch:
    inputs:
      users:
        description: "Number of users"
        required: true
        default: "5"
      spawn_rate:
        description: "Spawn rate (users per second)"
        required: true
        default: "1"
      duration:
        description: "Duration (e.g. 30s, 1m, 5m)"
        required: true
        default: "30s"
      stop_timeout:
        description: "Graceful shutdown wait time (e.g. 180s). Lets in-flight requests/cleanup finish."
        required: true
        default: "180s"
      test_file:
        description: "Which exact test file to run"
        required: true
        type: choice
        options:
          - "tests/staff/staff_get.py"
          - "tests/staff/staff_post.py"
          - "tests/staff/staff_put.py"
          - "tests/staff/staff_delete.py"
          - "tests/teams/teams_get.py"
          - "tests/teams/teams_post.py"
          - "tests/teams/teams_put.py"
          - "tests/teams/teams_delete.py"
          - "tests/users/users_get.py"
          - "tests/users/users_post.py"
          - "tests/users/users_put.py"
          - "tests/groups/groups_get.py"
          - "tests/groups/groups_post.py"
          - "tests/groups/groups_put.py"
          - "tests/groups/groups_delete.py"
          - "tests/integrations/integrations_get.py"
          - "tests/integrations/integrations_post.py"
          - "tests/integrations/integrations_put.py"
          - "tests/scorecards/scorecards_get.py"
          - "tests/scores/scores_get.py"

jobs:
  locust:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Make results folder
        run: mkdir -p results

      - name: Run Locust (headless)
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          API_HOST: ${{ secrets.API_HOST }}
        run: |
          locust \
            -f "${{ github.event.inputs.test_file }}" \
            --host "${{ secrets.API_HOST }}" \
            --users "${{ github.event.inputs.users }}" \
            --spawn-rate "${{ github.event.inputs.spawn_rate }}" \
            --run-time "${{ github.event.inputs.duration }}" \
            --stop-timeout "${{ github.event.inputs.stop_timeout }}" \
            --headless \
            --html results/report.html \
            --csv results/results

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: locust-results
          path: results/
          retention-days: 30